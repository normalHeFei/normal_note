> canal 同步工具实践记录

### canal 组成部分

1. 多个canal 实例 (借助zk保证HA)
2. 每个canal实例可以配置对应多个同步库,(按canal的说法就是多个instance)


#### 实践
 
从多个业务库,同步过滤统计需要的字段到统计库. 抽象统计因子, +-*/ 计算出指标值. 配合缓存

#### 疑问点实现

 
- canal 实例 HA 实现原理
> 同 zk 实现 HA 原理一致, 具体过程如下

1. 每个 canal server 实例启动时, 都会再zk 上注册一下, 并且尝试竞争称为 running 工作节点. 最终只会有一个竞争成功
2. 其他实例都会监听当前的running 节点. 如果running节点挂了. 或者running节点的连接信息被修改.收到通知后同步连接信息,重新建立新连接. 


- 如何实现多个 canal client 连接 canal server 只有一个client 可消费

1.  多个client 在zk 上创建节点 (节点代表工作的client)
2.  创建节点之前 先获得锁 (canal 中 通过 自定义 AQS 实现), 阻塞其他创建线程
3.  如果能成功创建节点说明已竞争成为work 实例. 其他创建线程阻塞 

- 所谓协议指的是什么, canal 中是怎么做的
  
1. 简单理解成交流 model 即可. 不同的应用要解决的问题不同,故协议对象里面需要包含的内容也就不同,如canal 需要记录同步锚点, 故协议对象中就有类似position的字段内容








